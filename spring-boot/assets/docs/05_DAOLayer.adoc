////
  Copyright 2021 The Bank of New York Mellon.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
////
= Spring Boot - the repository (DAO) layer
:toc:
:toclevels: 4

Building the *data access layer* (DAO) and its unit tests

== The Repository DAO Layer
Spring Data JPA takes care of most of the data access layer. +
⇒ link:../../todo/src/main/java/bnymellon/training/spring/boot/todo/dao/TodoRepository.java[TodoRepository.java]

. Most CRUD operations are supplied by the parent interface `JpaRepository` from Spring
(`org.springframework.data.jpa.repository` package) +
.. The `JpaRepository` extends the `PagingAndSortingRepository` which extends the `CrudRepository`.

. Custom finder methods +
.. In addition to the available-by-default CRUD operations, custom methods can be added. In the
`TodoRepository`, a `findByNotesContaining` operation is a custom find operation.
.. Constructing such custom operations requires a deeper understanding of how query methods are
generated by *Spring Data JPA*.
.. Refer to the
link:http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation[Spring documentation]
to read up on other phrases that JPA can use for database access.

. Using named queries +
.. A named query is an operation where a custom query is annotated using a `@Query` annotation.

NOTE: The named query uses Java class and field names, rather than database table and column names.

'''

== The Repository DAO unit test

. Ensure that `dbunit` dependencies are setup +
⇒ link:../../todo/pom.xml[pom.xml] +
.. Look for `dbunit` is a dependency in the `pom.xml`.

. Spring Boot test-related annotations +
⇒ link:../../todo/src/test/java/bnymellon/training/spring/boot/todo/dao/TodoRepositoryTest.java[TodoRepositoryTest.java] +
.. The JUnit 5 `@ExtendWith` annotation is set to include the `SpringExtension` thus registering that
this unit test is has a Spring context. +
.. The DAO is tested with `@SpringBootTest`. This is a special annotation with Spring Boot that
allows loading the Spring configuration. Specifying the `TodoApplication` provides the base
`@SpringBootApplication` which provides the component scanning instructions. +
.. The `@TestExecutionListeners` provide a set of event listeners for changes within the
Spring contexts.
.. The `@DatabaseSetup` puts the database in a state *_before each test method_* is executed. In
this example, a dataset is provided to seed the database. +
.. The `@DatabaseTearDown` resets the database *_after each test method_*. In this example,
everything in the database is deleted and then the provided dataset is applied.
.. The `@DirtiesContext` is a test hint to indicate that every test method may alter the Spring
context, and is thus an instruction for Spring to load a fresh context for each test method
execution.

. Seeder data in XML for testing the database +
⇒ link:../../todo/src/test/resources/datasets/todos.xml[todos.xml] +
.. The database is seeded/cleaned up via annotations on the class `@DatabaseSetup` and
`@DatabaseTearDown`.

NOTE: The dataset XML uses database table and column names, not the Java class and field names.

'''

== Exercise Lab

image:../../../assets/images/labtime.png[Lab, align="center"]

. Create the lab DAO and write its unit test. DAO methods:
.. Find By OwnerLastName, should return a list.
.. Find By Active = True, should return a list.
.. Find By Active = True And Owner Last Name, should return a list.
.. Find By First Name matching part of the string, should return an optional list.

NOTE: JPA uses the naming conventions of the Java object attribute. The seeder file uses the
naming convention of the `@Column`. Use lower case names for `@Column` and use an underscore as a
separator if needed.

CAUTION: Check the `JPARepository` generics, the ID for Account is a `String`, not a `Long` ...

'''

[width=100%, cols="<10%,^80%,>10%",grid=none,frame=ends]
|===
| Prev | TOC | Next

| link:04_ModelLayer.adoc[Working with the Model layer]
| link:TableOfContents.adoc[TOC]
| link:06_Exceptions.adoc[Working with Exceptions]
|===
